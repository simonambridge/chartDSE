# chartDSE - a simple demonstration of charting data from DSE/Cassandra tables generated by a Spark streaming data source. Visualised using a d3 dashboard using a ReST json API, collecting data from DSE using the DataStax Nodejs driver.

<H1>Source Data</H1>
THis demo queries a sysem table (compaction history) and a custom table containing time series data generated by this Spark Streaming example here https://github.com/simonambridge/SparkSensorData

You can change the simplechart.html file to query and display data from a different table. If you do this you will also need to edit app.js to change the ReST API query for your table.

##Install node.js

$ sudo curl -sL https://deb.nodesource.com/setup_7.x | sudo bash -
$ sudo apt-get install nodejs
$ npm install pug
$ npm install cassandra-driver

##Create test project to test Node server
$ mkdir test
$ cd test
$ npm init
$ npm install express --save
$ npm install connect serve-static
$ sudo npm install express-generator -g

Default server definition:
<pre>
$ vi app.js

var express = require('express');
var app = express();

app.get('/', function (req, res) {
  res.send('Hello World!');
});

app.listen(3000, function () {
  console.log('Example app listening on port 3000!');
});
</pre>

Start simple node server app:
$ node app.js

Example app listening on port 3000!

In your browser go to http://127.0.0.1:3000/

Browser displays:

HelloWorld!

Kill the server (press ^C).

Simple Server Example

$ node server - runs server.js file
gives simple server on port 8000
http://localhost:8000/chartdse/public/index.html

server.js:
var connect = require('connect');
var serveStatic = require('serve-static');
connect().use(serveStatic(__dirname)).listen(8000);

* if no start script in package .json it will default to this server.js

See http://expressjs.com/en/starter/basic-routing.html

===========================================

Now create a proper app:

From a parent directory create a new project and directory
<pre>
$ express chartdse

   create : chartdse
   create : chartdse/package.json
   create : chartdse/app.js
   create : chartdse/public
   create : chartdse/routes
   create : chartdse/routes/index.js
   create : chartdse/routes/users.js
   create : chartdse/views
   create : chartdse/views/index.jade
   create : chartdse/views/layout.jade
   create : chartdse/views/error.jade
   create : chartdse/bin
   create : chartdse/bin/www
   create : chartdse/public/javascripts
   create : chartdse/public/images
   create : chartdse/public/stylesheets
   create : chartdse/public/stylesheets/style.css

   install dependencies:
     $ cd chartdse && npm install

   run the app:
     $ DEBUG=chartdse:* npm start
</pre>

<pre>
$ cd ../chartdse
</pre>

Install local package dependencies:
<pre>
$ npm install
</pre>

Run the command:
<pre>
DEBUG=chartdse:* npm start           
</pre>
Output:
<pre>
> chartdse@0.0.0 start /root/chartdse
> node ./bin/www
  chartdse:server Listening on port 3000 +0ms

GGET / 200 364.402 ms - 170
GET /stylesheets/style.css 200 5.804 ms - 111
</pre>

http://127.0.0.1:3000/

Browser displays:

<pre>
Express

Welcome to Express
</pre>

##Important Files
app.js - defines the environment - server, port, paths etc. maps the /public directory for static content
app.js start element points to "./bin/www"
Port 3000 is defined in <project_dir>/bin/www - starts the http server

if an index.html file is in ./public then it will display that as the entry point e.g. http://localhost:3000 
If not then it will use index.jade  in /views and display the Express welcome message



##Example Cassandra Nodejs code:

var cassandra = require('cassandra-driver');
var client = new cassandra.Client({ contactPoints: ['localhost']});

client.execute('select key from system.local', function(err, result) {
  if (err) throw err;
  console.log(result.rows[0]);
});




# cat public/chart.html

Data we will pull from Cassandra
--------------------------------

system.compaction_history (
    id uuid PRIMARY KEY,
    bytes_in bigint,
    bytes_out bigint,
    columnfamily_name text,
    compacted_at timestamp,
    keyspace_name text,
    rows_merged map<int, bigint>

select keyspace_name, columnfamily_name, compacted_at, bytes_in, bytes_out from system.compaction_history

Simplechart.html - from ideas at https://github.com/ESeufert/d3.js-dashboard-examples






